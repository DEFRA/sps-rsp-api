
name: Sync subtree → Central (master)

on:
  push:
    branches: [ master ]

concurrency:
  group: subtree-pr-master
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

env:
  CENTRAL_REPO: DEFRA/sps-apim-gateway
  BASE_BRANCH: master
  TEAM_REMOTE_NAME: sps-rsp-api
  TEAM_REPO_URL: DEFRA/sps-rsp-api
  TEAM_BRANCH: master
  TEAM_WINS_ON_CONFLICT: "true"

  FOLDER_MAP: |
    internal/base/apis/rsp-api=internal/base/apis/rsp-api
    external/base/apis/rsp-api=external/base/apis/rsp-api
    internal/dev/apis/rsp-api=internal/dev/apis/rsp-api
    external/dev/apis/rsp-api=external/dev/apis/rsp-api
    internal/tst/apis/rsp-api=internal/tst/apis/rsp-api
    external/tst/apis/rsp-api=external/tst/apis/rsp-api
    internal/pre/apis/rsp-api=internal/pre/apis/rsp-api
    external/pre/apis/rsp-api=external/pre/apis/rsp-api

jobs:
  prepare-branch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout team repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.CENTRAL_SYNC_SSH_KEY }}

      - name: known_hosts
        run: ssh-keyscan -H github.com >> ~/.ssh/known_hosts

      - name: Git identity
        run: |
          git config --global user.name github-actions
          git config --global user.email github-actions@github.com

      - name: Clone central and prepare PR
        id: prep
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          set -x

          TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          git clone --depth=50 "git@github.com:${CENTRAL_REPO}.git" central
          cd central

          git fetch origin "${BASE_BRANCH}" --depth=50
          git checkout -B "${BASE_BRANCH}" "origin/${BASE_BRANCH}"

          git remote add team "https://x-access-token:${GITHUB_TOKEN}@github.com/${TEAM_REPO_URL}.git" \
            || git remote set-url team "https://x-access-token:${GITHUB_TOKEN}@github.com/${TEAM_REPO_URL}.git"
          git fetch team "${TEAM_BRANCH}"

          git checkout -B __team_branch__ "refs/remotes/team/${TEAM_BRANCH}"

          # Extract API name (rsp-api) automatically
          API_NAME=$(echo "${FOLDER_MAP}" | head -n 1 | sed 's/.*apis\///' | sed 's/=.*//')
          echo "API_NAME=${API_NAME}"

          CHANGES=false
          PR_BRANCH=""

          while IFS='=' read -r SRC TARGET; do
            [ -z "${SRC}" ] && continue

            SRC="${SRC%$'\r'}"
            TARGET="${TARGET%$'\r'}"

            echo ""
            echo "=== PROCESSING ${SRC} ==="

            git checkout __team_branch__

            if ! git rev-list -1 HEAD -- "${SRC}" > /dev/null 2>&1; then
              echo "No history for ${SRC}. Skipping"
              continue
            fi

            SPLIT_SHA=$(git subtree split -P "${SRC}" || true)
            if [ -z "${SPLIT_SHA}" ]; then
              echo "Empty split for ${SRC}. Skipping"
              continue
            fi
            echo "Split SHA = ${SPLIT_SHA}"

            MSG="Subtree sync: ${API_NAME} → master | api: ${API_NAME} | folder=${SRC} | ${TS}"

            # Create PR branch on first change
            if [ "${CHANGES}" = "false" ]; then
              PR_BRANCH="pr-subtree/${API_NAME}/$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA::7}"
              git checkout -B "${PR_BRANCH}" "${BASE_BRANCH}"
            else
              git checkout "${PR_BRANCH}"
            fi

            MERGE_FLAGS="-X subtree=${TARGET}"
            if [ "${TEAM_WINS_ON_CONFLICT}" = "true" ]; then
              MERGE_FLAGS="${MERGE_FLAGS} -X theirs"
            fi

            set +e
            git merge --no-commit -s recursive ${MERGE_FLAGS} "${SPLIT_SHA}" -m "${MSG}"
            RC=$?
            set -e

            if [ $RC -ne 0 ]; then
              echo "Merge failed — bootstrapping"
              git merge --abort 2>/dev/null || git reset --merge || true
              git reset --hard
              git rm -r --cached --ignore-unmatch "${TARGET}" || true
              git clean -fdx -- "${TARGET}" || true
              git read-tree --prefix="${TARGET}/" -u "${SPLIT_SHA}^{tree}"
              git add -A "${TARGET}"
              TREE=$(git write-tree)
              NEW=$(echo "${MSG}" | git commit-tree "$TREE" -p HEAD -p "${SPLIT_SHA}")
              git reset --hard "$NEW"
            else
              git commit -m "${MSG}" || true
            fi

            CHANGES=true
          done <<< "${FOLDER_MAP}"

          if [ "${CHANGES}" = "false" ]; then
            echo "PR_BRANCH=" >> $GITHUB_OUTPUT
            exit 0
          fi

          git push origin "${PR_BRANCH}"
          echo "PR_BRANCH=${PR_BRANCH}" >> $GITHUB_OUTPUT
          echo "PR_TITLE=Subtree sync: ${API_NAME} → master | api: ${API_NAME}" >> $GITHUB_OUTPUT

      - name: Summary
        run: |
          echo "**PR Branch:** ${{ steps.prep.outputs.PR_BRANCH }}" >> $GITHUB_STEP_SUMMARY
          echo "**PR Title:**  ${{ steps.prep.outputs.PR_TITLE }}" >> $GITHUB_STEP_SUMMARY
